<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/vaadin-grid/all-imports.html">

<link rel="import" href="/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../shared-styles.html">

<dom-module id="page-storages">
  <template>
    <style include="app-grid-style"></style>
    <style include="bootstrap"></style>
    <style include="shared-styles">
      :host {
        box-sizing: border-box;
        display: block;
        --app-grid-columns: 1;
        --app-grid-gutter: 15px;
        --app-grid-item-height: 100%;
        --app-grid-item-height: 100px;
        --paper-card: {

          width: 100%;
        }
      }

      .app-grid {
        height: 100%;
      }

      ul {
        padding: 0;
        list-style: none;
      }

      .item {
        background-color: white;
        height: 100%;
      }

      paper-input {
        width: 100%;
        height: 100%;
      }


      vaadin-grid {
        border-right: 0;
        border-left: 0;
        height: 100%;
      }


      paper-input[label="Search"] {
        width: 27%;
        float: right;
        padding: 0 28px;
      }

      paper-fab.createJobFab {
        --paper-fab-background: var(--paper-light-blue-700);
        position: fixed;
        right: 20px;
        bottom: 70px;
        z-index: 100;
      }

      vaadin-grid.material {
        --vaadin-grid-header-cell: {
          font-size: 14px !important;
          padding-left: 20px;
          height: initial;
          background: #fbfbfb;
        }
        ;
        --vaadin-grid-body-cell: {
          padding: 8px;
          padding-left: 8px;
          cursor: pointer;
          height: 48px;
          color: rgba(0, 0, 0, var(--dark-primary-opacity));
          font-size: 13px;
        }
        ;
        --vaadin-grid-body-row-hover-cell: {
          cursor: pointer;
          background-color: var(--paper-grey-200);
        }
        ;
      }

      .refreshbt {
        cursor: pointer;
        margin-right: 15px;
      }

      .refreshbt.active {
        animation-name: spin;
        animation-duration: 0.4s;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
    </style>
    <app-toolbar>
      <div main-title>
        <iron-icon icon="device:storage"></iron-icon> [[titlePage]] : [[profilename]]</div>
      <paper-input label="Search" value="{{_filterJobName::input}}">
        <iron-icon icon="icons:search" slot="prefix"></iron-icon>
      </paper-input>
      <iron-icon icon="icons:refresh" class="refreshbt" on-click="_refreshbt"></iron-icon>
    </app-toolbar>
    <!-- Fetch an array of users to be shown in the grid -->
    <!--<iron-ajax url="[[storagesapi]]" handle-as="json" last-response="{{storages}}" id="updateStorageLists" on-response="_loadStoragesComplete"></iron-ajax>-->
    <iron-ajax url="[[storagesapi]]" loading="{{loading}}" headers="[[headers]]" handle-as="json" last-response="{{storages}}" id="updateStorageLists"
      on-response="_loadStoragesComplete" on-error="_ajexerror" auto></iron-ajax>

    <!-- The array is set as the <vaadin-grid>'s "items" property -->
    <x-array-data-provider items="{{storageLists}}"></x-array-data-provider>
    <div class="app-grid">
      <paper-card class="item">
        <template is="dom-if" if="[[loading]]">
          <paper-progress value="10" indeterminate="true" style="width:100%;position: absolute;z-index: 1;"></paper-progress>
        </template>
        <vaadin-grid class="material" id="material" items="[[storageLists]]" on-active-item-changed="_selectStorage" on-selected-items-changed="_SelectedChanged" selected-items="{{storageSelected}}">

          <vaadin-grid-column width="50px" flex-grow="0">
            <template class="header">#</template>
            <template>
              <span style="text-align: center;display: block;">[[index]]</span>
            </template>
          </vaadin-grid-column>

          <vaadin-grid-column width="100px" flex="0">
            <template class="header">
              <vaadin-grid-filter aria-label="Job Name" path="_sid" value="[[_filterJobName]]">
                <input slot="filter" type="text" hidden>
              </vaadin-grid-filter>
              <vaadin-grid-sorter path="_sid">
                <div class="cell">
                  <span>Name</span>
                  <iron-icon icon="icons:arrow-upward"></iron-icon>
                </div>
              </vaadin-grid-sorter>
            </template>
            <template>
              <!--  -->
              <a href="/storages/detail/[[item._sid]]">
                <div class="cell">[[item._sid]]</div>
              </a>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column width="160px" flex-grow="0">
            <template class="header">
              <div class="cell">
                Action
              </div>
            </template>
            <template>
              <paper-checkbox aria-label="Select Row" checked="{{selected}}">
              </paper-checkbox>
            </template>
          </vaadin-grid-column>

        </vaadin-grid>

        <template is="dom-if" if="[[job_error]]">
          <div style="padding: 85px 15px 0;position: absolute;top: 0;width:100%;height: 100%;background: rgba(239, 239, 239, 0.79);    z-index: 112;">
            <div class="alert alert-danger" role="alert" style="width:100%">
              <template is="dom-if" if="[[isJobError404]]">
                <strong>Error !</strong> Can't GET [[storagesapi]], 404 (Not Found), Please go to
                <strong>
                  <a style="color: #aa4644;" href="/setting">Setting</a>
                </strong> to set other storages api
              </template>
              <template is="dom-if" if="[[!isJobError404]]">
                <!-- The request failed with status code: 401 (Unauthorized) -->
                [[errorMessage]], Please go to
                <strong>
                  <a style="color: #aa4644;" href="/setting">Setting</a>
                </strong> to set Your API Token
              </template>
            </div>
          </div>


        </template>

        <template is="dom-if" if="[[haveSelect]]">
          <paper-button class="btn  btn-danger" on-click="_deleteSelected" style="margin-top:10px;float: right;">
            <iron-icon icon="icons:delete"></iron-icon> Delete [[selectdItems.length]] item(s)
          </paper-button>
        </template>
      </paper-card>
    </div>

    <paper-dialog modal id="deleteConfirmDialog">
      <div class="form-group" style="margin-left: 15px">
        <h6>Are you sure to delete storage?</h6>
        <ul>
          <dom-repeat is="dom-repeat" items="[[selectdItems]]" as="item">
            <template>
              <li style="font-size: 1.1em">- [[item.sid]]</li>
            </template>
          </dom-repeat>
        </ul>
      </div>
      <div class="buttons">
        <paper-button class="btn btn-success" dialog-confirm on-click="_deleteStorageConfirm">Delete [[selectdItems.length]] item(s)</paper-button>
        <paper-button class="btn btn-danger" dialog-confirm>cancel</paper-button>
      </div>
    </paper-dialog>


    <paper-toast autoFitOnAttach id="toast"></paper-toast>

    <paper-dialog modal id="dialogError" style="z-index: 210;">
      <div class="form-group">
        <!-- <h6>Error</h6> -->
        <div>
          [[errorMessage]], Please go to Setting to set Your API Token
          <!-- <strong>
                <a style="color: #aa4644;" href="/setting">Setting</a>
              </strong> to set Your API Token -->
        </div>

      </div>
      <div class="buttons">
        <paper-button class="btn btn-danger" dialog-confirm>Ok</paper-button>
      </div>
    </paper-dialog>


  </template>

  <script>
    class PageStorages extends Polymer.Element {
      static get is() {
        return 'page-storages';
      }

      static get properties() {
        return {
          titlePage: {
            type: String,
            value: 'Storages lists'
          },
          storageLists: {
            type: Array,
            value: []
          },
          job_error_code: {
            type: Number
          },
          isJobError404: {
            type: Boolean
          },
          errorMessage: {
            type: String
          },
          selectdItems: {
            type: Array
          },
          haveSelect: {
            type: Boolean
          }

        };
      }
      ready() {
        super.ready();

        Polymer.RenderStatus.afterNextRender(this, function () {
          this._updatestorageLists();
        });

      }

      static get observers() {
        return [
          '_storageListsChanged(storageSelected)'
        ];
      }

      
      _storageListsChanged() {
        this.selectdItems = [];
        if (this.$.material.selectedItems.length >= 1)
          this.haveSelect = true;
        else
          this.haveSelect = false;
      }


      _SelectedChanged(ev, item) {
        // console.log("_observeSelected = ", ev);
        console.log("_observeSelected item = ", this.$.material.selectedItems);
        if (this.$.material.selectedItems.length >= 1)
          this.haveSelect = true;
        else
          this.haveSelect = false;

        let jsonStr = JSON.stringify(this.$.material.selectedItems);
        this.selectdItems = JSON.parse(jsonStr);
      }

      _selectStorage(ev, item) {
        if (this.$.material.activeItem != null) {
          // // this.dispatchEvent(new CustomEvent('selected-job-list', {
          // //   "detail": item.value
          // // }));
          // console.log("selected storage = ", item.value + " | len = ", this.selectdItems.length);
          // console.log("this.selectdItems = ", this.selectdItems);
        }
        this.$.material.activeItem = null;
      }

      _deleteSelected() {
        // console.log("delete item = ", this.selectdItems);
        this.$.deleteConfirmDialog.open();
      }

      _updatestorageLists() {
        this.$.updateStorageLists.generateRequest();
      }

      async _deleteStorageConfirm() {

        if (this.selectdItems && this.selectdItems.length > 0) {
          let length = this.selectdItems.length;
          // console.log("selectdItems = ", this.selectdItems);
          var gridItems = this.$.material.selectedItems;
          for (let item of this.selectdItems) {
            let pos = await this.findPositionOfItems(item._sid);
            let isDelete = await this.ajaxDeleteByID(item._sid);
            if (isDelete) {
              this.splice("storageLists", pos, 1);
              // console.log("delete success " + pos);
              gridItems.shift();
            }
            else {
              // console.log("delete failed " + pos);
            }
          }

          this.showToast("Delete " + length + " item(s) success");
        }
        else {
          this.showToast("No item(s) to delete");
        }

        this.clearStateDelete();
        // Polymer.dom(this.root).querySelectorAll('iron-ajax').forEach((el) => {
        //   el.generateRequest();
        // })
      }

      showToast(msg) {
        this.$.toast.text = msg;
        this.$.toast.horizontalAlign = "center";//"right";
        this.$.toast.verticalAlign = "bottom";//"top";
        this.$.toast.open();
      }

      async findPositionOfItems(id) {
        // console.log("id = " + id);
        return new Promise((res) => {
          let pos = this.storageLists.map(obj => obj._sid).indexOf(id);
          res(pos);
          // let i=0;
          // let pos = -1;
          // for (let item of this.storageLists) {
          //   if (item._jid == id){
          //     pos = i;
          //     console.log("found item at = "+pos+" | "+id);
          //   }
          //   i++;
          // }
          // res(pos);
        });
      }

      async ajaxDeleteByID(jid) {
        return new Promise((resolve) => {
          // let urlDelete = "http://phayao.bs.igridproject.info/api/storage/" + jid;
          let urlDelete = this.storagesapi + "/"+ jid;
          $.ajaxSetup({ "headers":this.headers } )
          $.ajax({
            url: urlDelete,
            type: 'DELETE',
            complete: (data) => {
              try {
                let res = data.statusText;
                if (res === "OK") {
                  // console.log('DELETE STATUS SUCCESS')
                  resolve(true);
                }
                else {
                  // console.log('DELETE STATUS FAILED', data)
                  resolve(false);
                }
              } catch (error) {
                console.log('error : ', error)
                resolve(false);
              }
            }
          })
        })
        // console.log("confirm delete = ",jid);
      }


      async _loadStoragesComplete(event) {
        let res = event.detail.response;;
       
        if (res) {
          console.log("_loadStoragesComplete complete = ", res.length);
        }
        else {
          console.log("_loadStoragesComplete error = ", event);
        }

        this.job_error = false;
        this.storageLists = [];

        if (this.storages && this.storages.length)
          this.storageLists = await this.getListStorageID();
        else {
          this.storageLists = [];
        }
          
        // this.$.material.clearCache();
        // console.log("storageLists = ", this.storageLists);
      }

      clearStateDelete() {
        this.storages = [];
        this.storageLists = [];
        this.set("storageLists",[]);
        this.set("storages",[]);
        this.selectdItems = [];
        this.haveSelect = false;
        this.$.material.clearCache();
        this.$.material.selectedItems = [];
        //console.log("clear data clearStateDelete : data = ",this.$.material.selectedItems);
      }

      async getListStorageID() {
        return new Promise((res) => {
          let items = [];
          if (this.storages) {
            for (let _sid of this.storages) {
              items.push({
                "_sid": _sid,
              });
            }
          }
          res(items);
        })
      }

      _ajexerror(ev) {
        let detail = "" + ev.detail.error;

        if (detail.indexOf("401") >= 0) {
          // console.log("error job_error 401");
          this.errorMessage = detail;
          this.job_error_code = 401;
          this.isJobError404 = false;

          // this.$.dialogError.open();

        }
        else {
          this.job_error_code = 404;
          this.isJobError404 = true;
          // console.log("error job_error ",detail);
        }

        // console.log("error job_error = ", detail + " | ", detail.indexOf("401") + " | ", this.job_error_code);


        this.storageLists = [];
        this.set("storageLists",[]);
        this.$.material.clearCache();
        this.job_error = true;

       
      }

      _refreshbt(ev) {

        this.storages = [];
        this.clearStateDelete();
        let refreshbt = Polymer.dom(this.root).querySelector('iron-icon.refreshbt');
        refreshbt.classList.remove('active');
        refreshbt.classList.add('active');
        setTimeout(() => {
          refreshbt.classList.remove('active');
        }, 400);
        Polymer.dom(this.root).querySelectorAll('iron-ajax').forEach((el) => {
          el.generateRequest();
        })


      }
    }

    window.customElements.define(PageStorages.is, PageStorages);
  </script>
</dom-module>